<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAR Image Tracking</title>
    
    <script>
        console.log("üîµ –ó–∞–≥—Ä—É–∑–∫–∞ A-Frame –∏ MindAR...");
    </script>

    <script src="https://aframe.io/releases/1.6.0/aframe.min.js" onerror="console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ aframe.min.js')"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.0/dist/mindar-image-aframe.prod.js" onerror="console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ mindar-image-aframe.prod.js')"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            background: black;
        }

        a-scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw !important;
            height: 100vh !important;
        }

        video {
            display: none;
        }

        #playButton {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 30px;
            font-size: 18px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            display: none;
        }
    </style>
</head>
<body>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            console.log("‚úÖ DOM –∑–∞–≥—Ä—É–∂–µ–Ω");
        });

        navigator.mediaDevices.getUserMedia({ video: true })
            .then((stream) => {
                console.log("‚úÖ –ö–∞–º–µ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞");
            })
            .catch((err) => console.error("‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:", err));

        AFRAME.registerComponent('debugger', {
            init: function () {
                console.log("üü° –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è A-Frame...");
                this.el.sceneEl.addEventListener('loaded', () => {
                    console.log("‚úÖ A-Frame —Å—Ü–µ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞");
                });
            }
        });

        window.addEventListener("resize", () => {
            const scene = document.querySelector("a-scene");
            if (scene) {
                scene.style.width = `${window.innerWidth}px`;
                scene.style.height = `${window.innerHeight}px`;
            }
        });
    </script>

    <button id="playButton">–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–∏–¥–µ–æ</button>

    <a-scene mindar-image="imageTargetSrc: ./assets/targets.mind;" embedded debugger>
        <a-camera mindar-camera="true" position="0 0 0" look-controls-enabled="false" cursor="rayOrigin: mouse"></a-camera>

        <a-assets>
            <video id="video1" src="video1.mp4" loop playsinline muted></video>
            <video id="video2" src="video2.mp4" loop playsinline muted></video>
        </a-assets>

        <a-entity mindar-image-targets>
            <a-entity mindar-image-target="targetIndex: 0">
                <a-video id="video1-entity" src="#video1" position="0 0 0" width="1" height="0.60" rotation="0 0 0"></a-video>
            </a-entity>

            <a-entity mindar-image-target="targetIndex: 1">
                <a-video id="video2-entity" src="#video2" position="0 0 0" width="1.77" height="1" rotation="0 0 90"></a-video>
            </a-entity>
        </a-entity>
    </a-scene>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            console.log("üü° –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏–¥–µ–æ...");

            const video1 = document.getElementById("video1");
            const video2 = document.getElementById("video2");
            const playButton = document.getElementById("playButton");

            video1.oncanplay = () => console.log("‚úÖ –í–∏–¥–µ–æ 1 –∑–∞–≥—Ä—É–∂–µ–Ω–æ");
            video2.oncanplay = () => console.log("‚úÖ –í–∏–¥–µ–æ 2 –∑–∞–≥—Ä—É–∂–µ–Ω–æ");

            const marker1 = document.querySelector('[mindar-image-target="targetIndex: 0"]');
            const marker2 = document.querySelector('[mindar-image-target="targetIndex: 1"]');

            let userInteracted = false;

            function enableVideoPlayback() {
                if (!userInteracted) {
                    userInteracted = true;
                    video1.play().catch(err => console.log("‚ö†Ô∏è –í–∏–¥–µ–æ 1 –Ω–µ –º–æ–∂–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è:", err));
                    video2.play().catch(err => console.log("‚ö†Ô∏è –í–∏–¥–µ–æ 2 –Ω–µ –º–æ–∂–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è:", err));
                    playButton.style.display = "none";
                }
            }

            document.addEventListener("click", enableVideoPlayback);
            document.addEventListener("touchstart", enableVideoPlayback);
            playButton.addEventListener("click", enableVideoPlayback);

            marker1.addEventListener("targetFound", () => {
                console.log("‚úÖ –ú–∞—Ä–∫–µ—Ä 1 –Ω–∞–π–¥–µ–Ω! –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –≤–∏–¥–µ–æ 1...");
                enableVideoPlayback();
                video1.muted = false;
                video1.play();
                updateTexture(video1, "#video1-entity");
            });

            marker1.addEventListener("targetLost", () => {
                console.log("üõë –ú–∞—Ä–∫–µ—Ä 1 –ø–æ—Ç–µ—Ä—è–Ω! –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–µ–æ 1...");
                video1.pause();
            });

            marker2.addEventListener("targetFound", () => {
                console.log("‚úÖ –ú–∞—Ä–∫–µ—Ä 2 –Ω–∞–π–¥–µ–Ω! –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –≤–∏–¥–µ–æ 2...");
                enableVideoPlayback();
                video2.muted = false;
                video2.play();
                updateTexture(video2, "#video2-entity");
            });

            marker2.addEventListener("targetLost", () => {
                console.log("üõë –ú–∞—Ä–∫–µ—Ä 2 –ø–æ—Ç–µ—Ä—è–Ω! –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–µ–æ 2...");
                video2.pause();
            });

            function updateTexture(video, selector) {
                setTimeout(() => {
                    const entity = document.querySelector(selector);
                    if (entity && entity.components.material) {
                        entity.components.material.material.map.needsUpdate = true;
                    }
                }, 100);
            }

            setTimeout(() => {
                if (video1.paused && video2.paused) {
                    console.log("‚ö†Ô∏è –í–∏–¥–µ–æ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–ª–∏–∫.");
                    playButton.style.display = "block";
                }
            }, 2000);

            // –û–±—Ö–æ–¥ –±–∞–≥–∞ WebGL –Ω–∞ iOS
            setTimeout(() => {
                const sceneEl = document.querySelector("a-scene");
                if (sceneEl && sceneEl.renderer && !sceneEl.renderer.context) {
                    console.log("‚ö†Ô∏è WebGL —Å–ª–æ–º–∞–Ω, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å—Ü–µ–Ω—É...");
                    location.reload();
                }
            }, 3000);
        });
    </script>
</body>
</html>
